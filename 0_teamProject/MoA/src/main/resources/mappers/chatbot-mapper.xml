<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.og.moa.chatbot.model.dao.ChatbotMapper">

	<!-- ChattingRoom ResultMap for KJY's' 1:1 & 1:n 채팅
	<resultMap type="ChattingRoomkjy" id="chattingRoom_rm"> 
	-->
		<!-- CHATTING_ROOM 테이블 컬럼 
		<id property="chattingNo" column="CHATTING_NO" />
		
		<result property="chCreateDate" column="CH_CREATE_DATE" />
		<result property="openMember" column="OPEN_MEMBER" />
		-->
		<!-- 채팅방 목록 조회 시 추가 정보
		<result property="memberCount" column="MEMBER_COUNT" />
		
		<result property="lastMessage" column="LAST_MESSAGE" />
		<result property="sendTime" column="SEND_TIME" />
		<result property="targetNo" column="TARGET_NO" />
		<result property="targetNickName" column="TARGET_NICKNAME" />
		<result property="targetProfile" column="TARGET_PROFILE" />
		<result property="notReadCount" column="NOT_READ_COUNT" />
		
		<result property="roomImage" column="ROOM_IMAGE" />
	</resultMap>
	 -->
	 
	 <!-- ChattingRoom DTO field명 vs. CHATTING_ROOM table column명 on 2025/11/08	-->	
	 <!-- ChattingRoom ResultMap for PYY's' chatbot -->
	 <resultMap type="ChattingRoom" id="chattingRoom_rm">
	     <id property="chattingNo" column="CHATTING_NO" />
	     
	     <result property="lastMessage" column="LAST_MESSAGE" />
	     <result property="sendTime" column="SEND_TIME" />
	     <result property="targetNo" column="TARGET_NO" />
	     <result property="targetNickName" column="TARGET_NICKNAME" />
	     <result property="targetProfile" column="TARGET_PROFILE" />
	     <result property="notReadCount" column="NOT_READ_COUNT" />
	 </resultMap>
	
	
	<!-- member ResultMap for KJY's' 1:1 & 1:n 채팅
	<resultMap type="Member" id="member_rm">
		<id property="memberNo" column="MEMBER_NO" />
		<result property="memberNickname" column="MEMBER_NICKNAME" />
		<result property="profileImg" column="PROFILE_IMG" />
	</resultMap>
	-->

	<!-- Member ResultMap for PYY's' chatbot -->
	<resultMap type="Member" id="member_rm"> <!-- Member의 별칭은 /common/config/DBconfig.java에 의해 자동 search&등록 되어있다. -->
		<!-- DB의 기본 키(복합키면 여러 개 작성) -->
		<id property="memberNo" column="MEMBER_NO" />
		<!-- DB의 일반 컬럼들: 항상 DTO의 모든 필드랑 맞출 필요는 없고 필요한 일부 DTO 필드만 맵핑해줘도 된다  -->
		<result property="memberEmail" column="MEMBER_EMAIL" />
		<result property="memberNickname" column="MEMBER_NICKNAME" />		
		<result property="profileImg" column="PROFILE_IMG" />
		<result property="memberDelFl" column="MEMBER_DEL_FL" />
		<result property="memberAdmin" column="MEMBER_ADMIN" />
		
	</resultMap>  
	

	<!-- Message ResultMap for KJY's' 1:1 & 1:n 채팅
	<resultMap type="Messagekjy" id="message_rm">
		<id property="messageNo" column="MESSAGE_NO" />
		<result property="messageContent" column="MESSAGE_CONTENT" />
		<result property="readFlag" column="READ_FL" />
		<result property="sendTime" column="SEND_TIME" />
		<result property="chattingNo" column="CHATTING_NO" />
		
		<result property="senderNo" column="SENDER_NO" />
		<result property="senderName" column="SENDER_NAME" />
		<result property="senderProfile" column="SENDER_PROFILE" />
	</resultMap>
	-->

	<!-- Message resultMap for PYY's' chatbot 2025/11/ -->
    <resultMap type="Message" id="message_rm">
        <id property="messageNo" column="MESSAGE_NO" />
        <result property="messageContent" column="MESSAGE_CONTENT" />
        <result property="readFlag" column="READ_FL" />
        <result property="chattingNo" column="CHATTING_NO" />
        <result property="sendTime" column="SEND_TIME" />
      
        <result property="senderNo" column="SENDER_NO" />   
	</resultMap>  
  

	
<!-- ################################################################################### -->
<!-- ################################################################################### -->
<!-- ################################################################################### -->



	<!-- MoA DB에 따른  selectRoomList이어야 함-->
	<!-- 채팅방 목록 조회 (targetNickName으로 통합 버전) -->
	<select id="selectRoomList" resultMap="chattingRoom_rm">
		SELECT
		CR.CHATTING_NO,
		CR.CH_CREATE_DATE,
		CR.OPEN_MEMBER,

		-- 참여자 수
		(SELECT COUNT(*)
		FROM CHAT_MEMBER
		WHERE CHATTING_NO = CR.CHATTING_NO) AS MEMBER_COUNT,

		-- 채팅방 이름 대신 참여자 닉네임 목록 (1:1 or 팀 자동 구분)
		CASE WHEN (SELECT COUNT(*) FROM CHAT_MEMBER WHERE CHATTING_NO = CR.CHATTING_NO) = 2 
		THEN
		-- 1:1일 때 : 상대방 닉네임
		(SELECT M.MEMBER_NICKNAME
		FROM CHAT_MEMBER CM2
		JOIN MEMBER M ON CM2.MEMBER_NO = M.MEMBER_NO
		WHERE CM2.CHATTING_NO = CR.CHATTING_NO
		AND CM2.MEMBER_NO != #{memberNo}
		AND ROWNUM = 1)
		ELSE
		-- 팀 채팅일 때 : 모든 닉네임 쉼표로 합치기
		(SELECT LISTAGG(M.MEMBER_NICKNAME, ', ')
		WITHIN GROUP (ORDER BY M.MEMBER_NICKNAME)
		FROM CHAT_MEMBER CM3
		JOIN MEMBER M ON CM3.MEMBER_NO = M.MEMBER_NO
		WHERE CM3.CHATTING_NO = CR.CHATTING_NO)
		END AS TARGET_NICKNAME,

		-- 1:1 채팅일 경우 상대방 번호
		CASE WHEN (SELECT COUNT(*) FROM CHAT_MEMBER WHERE CHATTING_NO = CR.CHATTING_NO) = 2 
		THEN
		(SELECT CM2.MEMBER_NO
		FROM CHAT_MEMBER CM2
		WHERE CM2.CHATTING_NO = CR.CHATTING_NO
		AND CM2.MEMBER_NO != #{memberNo}
		AND ROWNUM = 1)
		ELSE NULL
		END AS TARGET_NO,

		-- 1:1 채팅일 경우 상대방 프로필 이미지
		CASE WHEN (SELECT COUNT(*) FROM CHAT_MEMBER WHERE CHATTING_NO = CR.CHATTING_NO) = 2 
		THEN
		(SELECT M.PROFILE_IMG
		FROM CHAT_MEMBER CM2
		JOIN MEMBER M ON CM2.MEMBER_NO = M.MEMBER_NO
		WHERE CM2.CHATTING_NO = CR.CHATTING_NO
		AND CM2.MEMBER_NO != #{memberNo}
		AND ROWNUM = 1)
		ELSE NULL
		END AS TARGET_PROFILE,

		-- 마지막 메시지 내용
		(SELECT MESSAGE_CONTENT
		FROM CHATTING_MESSAGE
		WHERE CHATTING_NO = CR.CHATTING_NO
		AND MESSAGE_NO = (
		SELECT MAX(MESSAGE_NO)
		FROM CHATTING_MESSAGE
		WHERE CHATTING_NO = CR.CHATTING_NO
		)
		) AS LAST_MESSAGE,

		-- 마지막 메시지 시간
		(SELECT TO_CHAR(SEND_TIME, 'YYYY-MM-DD HH24:MI')
		FROM CHATTING_MESSAGE
		WHERE CHATTING_NO = CR.CHATTING_NO
		AND MESSAGE_NO = (
		SELECT MAX(MESSAGE_NO)
		FROM CHATTING_MESSAGE
		WHERE CHATTING_NO = CR.CHATTING_NO
		)
		) AS SEND_TIME,

		-- 안 읽은 메시지 수
		(SELECT COUNT(*)
		FROM CHATTING_MESSAGE
		WHERE CHATTING_NO = CR.CHATTING_NO
		AND READ_FL = 'N'
		AND MEMBER_NO != #{memberNo}
		) AS NOT_READ_COUNT

		FROM CHATTING_ROOM CR
		WHERE CR.CHATTING_NO IN (
		SELECT CHATTING_NO
		FROM CHAT_MEMBER
		WHERE MEMBER_NO = #{memberNo}
		)
		ORDER BY
		(SELECT MAX(MESSAGE_NO)
		FROM CHATTING_MESSAGE
		WHERE CHATTING_NO = CR.CHATTING_NO
		) DESC NULLS LAST
	</select>


	<!-- 0_MoA project 에서의 selectTargetList 필터링 조건 -->
	<select id="selectTargetList" resultType="Member"> 
		SELECT MEMBER_NO, MEMBER_NICKNAME, PROFILE_IMG, MEMBER_EMAIL, MEMBER_ADMIN 
		FROM MEMBER 
		WHERE MEMBER_NO != #{memberNo} 
		AND MEMBER_DEL_FL = 'N' 
		<if test="query != null and query != ''">
			AND LOWER(MEMBER_NICKNAME) LIKE LOWER('%' || #{query} || '%')
		</if>
		ORDER BY MEMBER_NICKNAME 
	</select>		
	<!-- cf) 6_SpringBoot-board project 에서의 selectTargetList 필터링 조건 -->
	<!-- WHERE (MEMBER_EMAIL LIKE '${query}%' OR MEMBER_NICKNAME LIKE '%${query}%'-->


	<!-- 채팅방 입장위해, 기존 채팅방 존재여부(chattingNo) 확인하고, 없은면 생성-->
	<!-- 1) 기존 채팅방 존재여부(chattingNo) 확인 -->
	<!-- 기존 채팅방 존재여부 확인 (1:1채팅경우) -->
	<select id="checkChattingNo" parameterType="map" resultType="int">
		SELECT CHATTING_NO
		FROM (
		SELECT CR.CHATTING_NO
		FROM CHATTING_ROOM CR
		WHERE CR.CHATTING_NO IN (
		SELECT CHATTING_NO
		FROM CHAT_MEMBER
		WHERE MEMBER_NO IN (#{loginMemberNo}, #{targetNo})
		GROUP BY CHATTING_NO
		HAVING COUNT(DISTINCT MEMBER_NO) = 2
		)
		AND (
		SELECT COUNT(*)
		FROM CHAT_MEMBER
		WHERE CHATTING_NO = CR.CHATTING_NO
		) = 2
		ORDER BY CR.CH_CREATE_DATE DESC -- 최근 생성된 방 우선
		)
		WHERE ROWNUM = 1
	</select>

	<!-- 2) 기존 채팅방 존재(chattingNo)하지 않으면, 우선 채팅방 생성(CHATTING_ROOM 테이블) 하고 -->
	<!-- 채팅방 생성 (1:1채팅의 경우) - selectKey 추가 -->
	<insert id="createChattingRoom" parameterType="map" useGeneratedKeys="true">
		<selectKey keyProperty="chattingNo" resultType="_int" order="BEFORE">
		SELECT SEQ_CHATTING_NO.NEXTVAL FROM DUAL
		</selectKey> 
		INSERT INTO CHATTING_ROOM (CHATTING_NO, CH_CREATE_DATE, OPEN_MEMBER) 
		VALUES (#{chattingNo}, SYSDATE, #{loginMemberNo}) 
	</insert>

	<!-- 3)  생성한 채팅방 번호로 참여 member들 등록(CHATTING_MEMBER 테이블) -->
	<!-- 두 명 모두 CHAT_MEMBER 테이블에 등록 -->
	<insert id="insertChatMember" parameterType="map">
		INSERT INTO CHAT_MEMBER (CHATTING_NO, MEMBER_NO)
		VALUES (#{chattingNo}, #{memberNo})
	</insert>


	<!-- 채팅 읽음 표시 -->
	<update id="updateReadFlag" parameterType="map">
		UPDATE CHATTING_MESSAGE
		SET READ_FL = 'Y'
		WHERE CHATTING_NO = #{chattingNo}
		AND MEMBER_NO != #{memberNo}
		AND READ_FL = 'N'
	</update>


	<!-- 채팅방 메세지 목록 조회 - parameterType 수정 -->
	<select id="selectMessageList" parameterType="int" resultMap="message_rm">
		SELECT MESSAGE_NO, MESSAGE_CONTENT, READ_FL,
			TO_CHAR(SEND_TIME, 'YYYY.MM.DD HH24:MI') AS SEND_TIME, 
			CHATTING_NO, MEMBER_NO AS SENDER_NO
		FROM CHATTING_MESSAGE
		WHERE CHATTING_NO = #{chattingNo}
		ORDER BY MESSAGE_NO
	</select>
	
	
	<!-- 메세지 삽입 -->
	<insert id="insertMessage">

		INSERT INTO CHATTING_MESSAGE (
		MESSAGE_NO,
		MESSAGE_CONTENT,
		READ_FL,
		SEND_TIME,
		CHATTING_NO,
		MEMBER_NO
		)
		VALUES (
		SEQ_MESSAGE_NO.NEXTVAL,
		#{messageContent},
		'N',
		SYSDATE,
		#{chattingNo},
		#{senderNo}
		)
	</insert>




<!-- ################################################################################### -->
<!-- ################################################################################### -->
<!-- ################################################################################### -->

	<!-- 채팅방 나가기 - CHAT_MEMBER에서 해당 멤버 삭제 -->
	<delete id="exitRoom" parameterType="map">
		DELETE FROM CHAT_MEMBER
		WHERE CHATTING_NO = #{chattingNo}
		AND MEMBER_NO = #{memberNo}
	</delete>

	<!-- 채팅방에 남은 멤버 수 조회 -->
	<select id="getRemainingMemberCount" parameterType="int" resultType="int">
		SELECT COUNT(*)
		FROM CHAT_MEMBER
		WHERE CHATTING_NO = #{chattingNo}
	</select>

	<!-- 빈 채팅방 삭제 (멤버가 0명일 때), KJY, ? -->
	<delete id="deleteEmptyRoom" parameterType="int">
		<!-- 먼저 해당 채팅방의 모든 메시지 삭제 --> 
		DELETE FROM	CHATTING_MESSAGE 
		WHERE CHATTING_NO = #{chattingNo} 
	</delete>

	<!-- 채팅 메시지 삭제 -->
	<delete id="deleteChatMessages" parameterType="int">
		DELETE FROM CHATTING_MESSAGE
		WHERE CHATTING_NO = #{chattingNo}
	</delete>


	<!-- chatting-mapper.xml -->
	<select id="getChattingRoomMembers" parameterType="int" resultType="int">
		SELECT MEMBER_NO
		FROM CHAT_MEMBER
		WHERE CHATTING_NO = #{chattingNo}
	</select>

</mapper>
